{
  "name": "Var_to_Plan_%_test",
  "expression": [
    "",
    "VAR Item1 = SELECTEDVALUE( 'Financial Metrics'[Calculation group column] )",
    "",
    "VAR IsGrossProfitTotalRow =",
    "    Item1 = \"Gross Profit\"",
    "    && NOT ISINSCOPE( 'transaction_master'[gl_category_2] )",
    "    && NOT ISINSCOPE( 'transaction_master'[gl_category_3] )",
    "",
    "VAR IsGrossProfitChildRow =",
    "    Item1 = \"Gross Profit\"",
    "    && SELECTEDVALUE( 'transaction_master'[gl_category_1] ) IN { \"Revenue\", \"COGS\" }",
    "",
    "VAR IsEBITDATotalRow =",
    "    Item1 = \"EBITDA\"",
    "    && NOT ISINSCOPE( 'transaction_master'[gl_category_2] )",
    "    && NOT ISINSCOPE( 'transaction_master'[gl_category_3] )",
    "",
    "VAR IsEBITDAChildRow =",
    "    Item1 = \"EBITDA\"",
    "    && SELECTEDVALUE( 'transaction_master'[gl_category_1] ) IN { \"Revenue\", \"COGS\", \"SG&A\" }",
    "",
    "VAR IsNetIncomeTotalRow =",
    "    Item1 = \"Net Income\"",
    "    && NOT ISINSCOPE( 'transaction_master'[gl_category_2] )",
    "    && NOT ISINSCOPE( 'transaction_master'[gl_category_3] )",
    "",
    "VAR IsNetIncomeChildRow =",
    "    Item1 = \"Net Income\"",
    "    && SELECTEDVALUE( 'transaction_master'[gl_category_1] ) IN { \"Revenue\", \"COGS\", \"SG&A\", \"Other\" }",
    "",
    "VAR IsODITotalRow =",
    "    Item1 = \"Owners Discretionary Income\"",
    "    && NOT ISINSCOPE( 'transaction_master'[gl_category_2] )",
    "    && NOT ISINSCOPE( 'transaction_master'[gl_category_3] )",
    "",
    "VAR IsODIChildRow =",
    "    Item1 = \"Owners Discretionary Income\"",
    "    && SELECTEDVALUE( 'transaction_master'[gl_category_1] ) IN { \"Revenue\", \"COGS\", \"SG&A\", \"Other\", \"ODE\" }",
    "",
    "// Base line‐item values",
    "VAR Actual = [Actual_rev]",
    "VAR Plan   = [plan_rev]",
    "VAR Delta  = DIVIDE( Actual - Plan, Plan, 0 )",
    "",
    "// Break out Actual by category",
    "VAR Actual_Revenue =",
    "    CALCULATE(",
    "        [Actual_rev],",
    "        REMOVEFILTERS(",
    "            'transaction_master'[gl_category_1],",
    "            'transaction_master'[gl_category_2],",
    "            'transaction_master'[gl_category_3]",
    "        ),",
    "        'transaction_master'[gl_category_1] = \"Revenue\"",
    "    )",
    "VAR Actual_COGS =",
    "    CALCULATE(",
    "        [Actual_rev],",
    "        REMOVEFILTERS(",
    "            'transaction_master'[gl_category_1],",
    "            'transaction_master'[gl_category_2],",
    "            'transaction_master'[gl_category_3]",
    "        ),",
    "        'transaction_master'[gl_category_1] = \"COGS\"",
    "    )",
    "VAR Actual_SGA =",
    "    CALCULATE(",
    "        [Actual_rev],",
    "        REMOVEFILTERS(",
    "            'transaction_master'[gl_category_1],",
    "            'transaction_master'[gl_category_2],",
    "            'transaction_master'[gl_category_3]",
    "        ),",
    "        'transaction_master'[gl_category_1] = \"SG&A\"",
    "    )",
    "VAR Actual_Other =",
    "    CALCULATE(",
    "        [Actual_rev],",
    "        REMOVEFILTERS(",
    "            'transaction_master'[gl_category_1],",
    "            'transaction_master'[gl_category_2],",
    "            'transaction_master'[gl_category_3]",
    "        ),",
    "        'transaction_master'[gl_category_1] = \"Other\"",
    "    )",
    "VAR Actual_ODE =",
    "    CALCULATE(",
    "        [Actual_rev],",
    "        REMOVEFILTERS(",
    "            'transaction_master'[gl_category_1],",
    "            'transaction_master'[gl_category_2],",
    "            'transaction_master'[gl_category_3]",
    "        ),",
    "        'transaction_master'[gl_category_1] = \"ODE\"",
    "    )",
    "",
    "// Break out Plan by category",
    "VAR Plan_Revenue =",
    "    CALCULATE(",
    "        [plan_rev],",
    "        REMOVEFILTERS(",
    "            'transaction_master'[gl_category_1],",
    "            'transaction_master'[gl_category_2],",
    "            'transaction_master'[gl_category_3]",
    "        ),",
    "        'transaction_master'[gl_category_1] = \"Revenue\"",
    "    )",
    "VAR Plan_COGS =",
    "    CALCULATE(",
    "        [plan_rev],",
    "        REMOVEFILTERS(",
    "            'transaction_master'[gl_category_1],",
    "            'transaction_master'[gl_category_2],",
    "            'transaction_master'[gl_category_3]",
    "        ),",
    "        'transaction_master'[gl_category_1] = \"COGS\"",
    "    )",
    "VAR Plan_SGA =",
    "    CALCULATE(",
    "        [plan_rev],",
    "        REMOVEFILTERS(",
    "            'transaction_master'[gl_category_1],",
    "            'transaction_master'[gl_category_2],",
    "            'transaction_master'[gl_category_3]",
    "        ),",
    "        'transaction_master'[gl_category_1] = \"SG&A\"",
    "    )",
    "VAR Plan_Other =",
    "    CALCULATE(",
    "        [plan_rev],",
    "        REMOVEFILTERS(",
    "            'transaction_master'[gl_category_1],",
    "            'transaction_master'[gl_category_2],",
    "            'transaction_master'[gl_category_3]",
    "        ),",
    "        'transaction_master'[gl_category_1] = \"Other\"",
    "    )",
    "VAR Plan_ODE =",
    "    CALCULATE(",
    "        [plan_rev],",
    "        REMOVEFILTERS(",
    "            'transaction_master'[gl_category_1],",
    "            'transaction_master'[gl_category_2],",
    "            'transaction_master'[gl_category_3]",
    "        ),",
    "        'transaction_master'[gl_category_1] = \"ODE\"",
    "    )",
    "",
    "// Gross Profit",
    "VAR GP_Actual = Actual_Revenue - Actual_COGS",
    "VAR GP_Plan   = Plan_Revenue   - Plan_COGS",
    "VAR GP_Delta  = DIVIDE( GP_Actual - GP_Plan, GP_Plan, 0 )",
    "",
    "// EBITDA (Plan–Actual) ÷ Plan",
    "VAR EBITDA_Actual = Actual_Revenue - Actual_COGS - Actual_SGA",
    "VAR EBITDA_Plan   = Plan_Revenue   - Plan_COGS   - Plan_SGA",
    "VAR EBITDA_Delta  = DIVIDE( EBITDA_Plan - EBITDA_Actual, EBITDA_Plan, 0 )",
    "",
    "// Net Income (Plan–Actual) ÷ Plan",
    "VAR NetIncome_Actual = Actual_Revenue - Actual_COGS - Actual_SGA - Actual_Other",
    "VAR NetIncome_Plan   = Plan_Revenue   - Plan_COGS   - Plan_SGA   - Plan_Other",
    "VAR NetIncome_Delta  = DIVIDE( NetIncome_Plan - NetIncome_Actual, NetIncome_Plan, 0 )",
    "",
    "// Owners Discretionary Income (Plan–Actual) ÷ Plan",
    "VAR ODI_Actual = NetIncome_Actual + Actual_ODE",
    "VAR ODI_Plan   = NetIncome_Plan   + Plan_ODE",
    "VAR ODI_Delta  = DIVIDE( ODI_Plan - ODI_Actual, ODI_Plan, 0 )",
    "",
    "RETURN",
    "SWITCH(",
    "    TRUE(),",
    "    // Detail rows",
    "    Item1 = \"Revenue\",                     Delta,",
    "    Item1 IN { \"COGS\", \"SG&A\", \"Other\" }, -Delta,",
    "",
    "    // Gross Profit",
    "    IsGrossProfitTotalRow,                GP_Delta,",
    "    IsGrossProfitChildRow,                Delta,",
    "",
    "    // EBITDA: flipped sign",
    "    IsEBITDATotalRow,                    -EBITDA_Delta,",
    "    IsEBITDAChildRow,                     Delta,",
    "",
    "    // Net Income: flipped sign",
    "    IsNetIncomeTotalRow,                 -NetIncome_Delta,",
    "    IsNetIncomeChildRow,                  Delta,",
    "",
    "    // Owners Discretionary Income: flipped sign",
    "    IsODITotalRow,                       -ODI_Delta,",
    "    IsODIChildRow,                        Delta,",
    "",
    "    BLANK()",
    ")",
    ""
  ],
  "formatString": "0%;-0%;0%",
  "displayFolder": "_Measures_Active",
  "lineageTag": "e57006fc-4a9b-4917-a98e-4ac934857960",
  "changedProperties": [
    {
      "property": "DisplayFolder"
    },
    {
      "property": "Name"
    },
    {
      "property": "FormatString"
    }
  ]
}