{
  "name": "Var_to_Plan_%_test_1",
  "expression": [
    "",
    "VAR Item1 = SELECTEDVALUE( 'Financial Metrics'[Calculation group column] )",
    "",
    "// Base Actual vs Plan %",
    "VAR Actual = [Actual_rev]",
    "VAR Plan   = [Plan_rev]",
    "VAR Delta  = DIVIDE( Actual - Plan, Plan )",
    "",
    "// Aggregate Actual values (remove all category filters)",
    "VAR Actual_Revenue =",
    "    CALCULATE(",
    "        [Actual_rev],",
    "        REMOVEFILTERS(",
    "            'transaction_master'[gl_category_1],",
    "            'transaction_master'[gl_category_2],",
    "            'transaction_master'[gl_category_3]",
    "        ),",
    "        'transaction_master'[gl_category_1] = \"Revenue\"",
    "    )",
    "VAR Actual_COGS =",
    "    CALCULATE( [Actual_rev],",
    "        REMOVEFILTERS(",
    "            'transaction_master'[gl_category_1],",
    "            'transaction_master'[gl_category_2],",
    "            'transaction_master'[gl_category_3]",
    "        ),",
    "        'transaction_master'[gl_category_1] = \"COGS\"",
    "    )",
    "VAR Actual_SGA =",
    "    CALCULATE( [Actual_rev],",
    "        REMOVEFILTERS(",
    "            'transaction_master'[gl_category_1],",
    "            'transaction_master'[gl_category_2],",
    "            'transaction_master'[gl_category_3]",
    "        ),",
    "        'transaction_master'[gl_category_1] = \"SG&A\"",
    "    )",
    "VAR Actual_Other =",
    "    CALCULATE( [Actual_rev],",
    "        REMOVEFILTERS(",
    "            'transaction_master'[gl_category_1],",
    "            'transaction_master'[gl_category_2],",
    "            'transaction_master'[gl_category_3]",
    "        ),",
    "        'transaction_master'[gl_category_1] = \"Other\"",
    "    )",
    "VAR Actual_ODE =",
    "    CALCULATE( [Actual_rev],",
    "        REMOVEFILTERS(",
    "            'transaction_master'[gl_category_1],",
    "            'transaction_master'[gl_category_2],",
    "            'transaction_master'[gl_category_3]",
    "        ),",
    "        'transaction_master'[gl_category_1] = \"ODE\"",
    "    )",
    "",
    "// Aggregate Plan values the same way",
    "VAR Plan_Revenue =",
    "    CALCULATE(",
    "        [Plan_rev],",
    "        REMOVEFILTERS(",
    "            'transaction_master'[gl_category_1],",
    "            'transaction_master'[gl_category_2],",
    "            'transaction_master'[gl_category_3]",
    "        ),",
    "        'transaction_master'[gl_category_1] = \"Revenue\"",
    "    )",
    "VAR Plan_COGS =",
    "    CALCULATE( [Plan_rev],",
    "        REMOVEFILTERS(",
    "            'transaction_master'[gl_category_1],",
    "            'transaction_master'[gl_category_2],",
    "            'transaction_master'[gl_category_3]",
    "        ),",
    "        'transaction_master'[gl_category_1] = \"COGS\"",
    "    )",
    "VAR Plan_SGA =",
    "    CALCULATE( [Plan_rev],",
    "        REMOVEFILTERS(",
    "            'transaction_master'[gl_category_1],",
    "            'transaction_master'[gl_category_2],",
    "            'transaction_master'[gl_category_3]",
    "        ),",
    "        'transaction_master'[gl_category_1] = \"SG&A\"",
    "    )",
    "VAR Plan_Other =",
    "    CALCULATE( [Plan_rev],",
    "        REMOVEFILTERS(",
    "            'transaction_master'[gl_category_1],",
    "            'transaction_master'[gl_category_2],",
    "            'transaction_master'[gl_category_3]",
    "        ),",
    "        'transaction_master'[gl_category_1] = \"Other\"",
    "    )",
    "VAR Plan_ODE =",
    "    CALCULATE( [Plan_rev],",
    "        REMOVEFILTERS(",
    "            'transaction_master'[gl_category_1],",
    "            'transaction_master'[gl_category_2],",
    "            'transaction_master'[gl_category_3]",
    "        ),",
    "        'transaction_master'[gl_category_1] = \"ODE\"",
    "    )",
    "",
    "// Derive each group’s Plan‐based variance",
    "VAR GP_Delta =",
    "    DIVIDE(",
    "        ( Actual_Revenue - Actual_COGS )",
    "      - ( Plan_Revenue   - Plan_COGS ),",
    "      Plan_Revenue   - Plan_COGS",
    "    )",
    "VAR EBITDA_Delta =",
    "    DIVIDE(",
    "        ( Actual_Revenue - Actual_COGS - Actual_SGA )",
    "      - ( Plan_Revenue   - Plan_COGS   - Plan_SGA ),",
    "      Plan_Revenue   - Plan_COGS   - Plan_SGA",
    "    )",
    "VAR NetIncome_Delta =",
    "    DIVIDE(",
    "        ( Actual_Revenue - Actual_COGS - Actual_SGA - Actual_Other )",
    "      - ( Plan_Revenue   - Plan_COGS   - Plan_SGA   - Plan_Other ),",
    "      Plan_Revenue   - Plan_COGS   - Plan_SGA   - Plan_Other",
    "    )",
    "VAR ODI_Delta =",
    "    DIVIDE(",
    "        ( (Actual_Revenue - Actual_COGS - Actual_SGA - Actual_Other) + Actual_ODE )",
    "      - ( (Plan_Revenue   - Plan_COGS   - Plan_SGA   - Plan_Other) + Plan_ODE ),",
    "      (Plan_Revenue   - Plan_COGS   - Plan_SGA   - Plan_Other) + Plan_ODE",
    "    )",
    "",
    "RETURN",
    "SWITCH(",
    "    TRUE(),",
    "",
    "    // —— Root‐level Revenue & Cost line items ——",
    "    Item1 = \"Revenue\", Delta,",
    "    Item1 IN { \"COGS\", \"SG&A\" }, -Delta,",
    "",
    "    // —— Gross Profit group ——",
    "    Item1 = \"Gross Profit\"",
    "        && NOT ISINSCOPE('transaction_master'[gl_category_2])",
    "        && NOT ISINSCOPE('transaction_master'[gl_category_3]),",
    "        GP_Delta,",
    "    Item1 = \"Gross Profit\"",
    "        && SELECTEDVALUE('transaction_master'[gl_category_1]) IN { \"Revenue\", \"COGS\" },",
    "        Delta,",
    "",
    "    // —— EBITDA group ——",
    "    Item1 = \"EBITDA\"",
    "        && NOT ISINSCOPE('transaction_master'[gl_category_2])",
    "        && NOT ISINSCOPE('transaction_master'[gl_category_3]),",
    "        EBITDA_Delta,",
    "    Item1 = \"EBITDA\"",
    "        && SELECTEDVALUE('transaction_master'[gl_category_1]) IN { \"Revenue\", \"COGS\", \"SG&A\" },",
    "        Delta,",
    "",
    "    // —— Net Income group ——",
    "    Item1 = \"Net Income\"",
    "        && NOT ISINSCOPE('transaction_master'[gl_category_2])",
    "        && NOT ISINSCOPE('transaction_master'[gl_category_3]),",
    "        NetIncome_Delta,",
    "    Item1 = \"Net Income\"",
    "        && SELECTEDVALUE('transaction_master'[gl_category_1]) IN { \"Revenue\", \"COGS\", \"SG&A\", \"Other\" },",
    "        Delta,",
    "",
    "    // —— Owners Discretionary Income group ——",
    "    Item1 = \"Owners Discretionary Income\"",
    "        && NOT ISINSCOPE('transaction_master'[gl_category_2])",
    "        && NOT ISINSCOPE('transaction_master'[gl_category_3]),",
    "        ODI_Delta,",
    "",
    "    //   • ODE as its own child line should be Plan–Actual/Plan",
    "    Item1 = \"Owners Discretionary Income\"",
    "        && SELECTEDVALUE('transaction_master'[gl_category_1]) = \"ODE\",",
    "        -Delta,",
    "",
    "    //   • All other child rows use base (Actual–Plan)/Plan",
    "    Item1 = \"Owners Discretionary Income\"",
    "        && SELECTEDVALUE('transaction_master'[gl_category_1]) IN { \"Revenue\", \"COGS\", \"SG&A\", \"Other\" },",
    "        Delta,",
    "",
    "    BLANK()",
    ")",
    ""
  ],
  "formatString": "0.0%;-0.0%;0.0%",
  "displayFolder": "_Measures_Active",
  "lineageTag": "c8b655bb-4ad5-487c-beea-a0092a3c1c63",
  "changedProperties": [
    {
      "property": "DisplayFolder"
    },
    {
      "property": "Name"
    },
    {
      "property": "FormatString"
    }
  ]
}