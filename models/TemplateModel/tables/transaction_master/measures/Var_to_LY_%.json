{
  "name": "Var_to_LY_%",
  "expression": [
    "",
    "",
    "VAR Item1 = SELECTEDVALUE('Financial Metrics'[Calculation group column])",
    "",
    "VAR IsGrossProfitTotalRow =",
    "    Item1 = \"Gross Profit\" &&",
    "    NOT ISINSCOPE('transaction_master'[gl_category_2]) &&",
    "    NOT ISINSCOPE('transaction_master'[gl_category_3])",
    "",
    "VAR IsGrossProfitChildRow =",
    "    Item1 = \"Gross Profit\" &&",
    "    SELECTEDVALUE('transaction_master'[gl_category_1]) IN { \"Revenue\", \"COGS\" }",
    "",
    "VAR IsEBITDATotalRow =",
    "    Item1 = \"EBITDA\" &&",
    "    NOT ISINSCOPE('transaction_master'[gl_category_2]) &&",
    "    NOT ISINSCOPE('transaction_master'[gl_category_3])",
    "",
    "VAR IsEBITDAChildRow =",
    "    Item1 = \"EBITDA\" &&",
    "    SELECTEDVALUE('transaction_master'[gl_category_1]) IN { \"Revenue\", \"COGS\", \"SG&A\" }",
    "",
    "VAR IsNetIncomeTotalRow =",
    "    Item1 = \"Net Income\" &&",
    "    NOT ISINSCOPE('transaction_master'[gl_category_2]) &&",
    "    NOT ISINSCOPE('transaction_master'[gl_category_3])",
    "",
    "VAR IsNetIncomeChildRow =",
    "    Item1 = \"Net Income\" &&",
    "    SELECTEDVALUE('transaction_master'[gl_category_1]) IN { \"Revenue\", \"COGS\", \"SG&A\", \"Other\" }",
    "",
    "VAR IsODITotalRow =",
    "    Item1 = \"Owners Discretionary Income\" &&",
    "    NOT ISINSCOPE('transaction_master'[gl_category_2]) &&",
    "    NOT ISINSCOPE('transaction_master'[gl_category_3])",
    "",
    "VAR IsODIChildRow =",
    "    Item1 = \"Owners Discretionary Income\" &&",
    "    SELECTEDVALUE('transaction_master'[gl_category_1]) IN { \"Revenue\", \"COGS\", \"SG&A\", \"Other\",\"ODE\"}",
    "",
    "-- Debug Step",
    "-- VAR ApplyGPDelta = IsGrossProfitTotalRow",
    "",
    "-- Standard % change",
    "VAR Actual = [Actual_rev]",
    "VAR LY = [LY_rev]",
    "VAR Delta  = DIVIDE(Actual - LY, LY)",
    "",
    "-- Custom Gross Profit logic",
    "VAR Actual_Revenue =",
    "    CALCULATE(",
    "        [Actual_rev],",
    "        REMOVEFILTERS(",
    "            'transaction_master'[gl_category_1],",
    "            'transaction_master'[gl_category_2],",
    "            'transaction_master'[gl_category_3]",
    "        ),",
    "        'transaction_master'[gl_category_1] = \"Revenue\"",
    "    )",
    "",
    "VAR Actual_COGS =",
    "    CALCULATE(",
    "        [Actual_rev],",
    "        REMOVEFILTERS(",
    "            'transaction_master'[gl_category_1],",
    "            'transaction_master'[gl_category_2],",
    "            'transaction_master'[gl_category_3]",
    "        ),",
    "        'transaction_master'[gl_category_1] = \"COGS\"",
    "    )",
    "VAR Actual_SGA =",
    "    CALCULATE(",
    "        [Actual_rev],",
    "        REMOVEFILTERS(",
    "            'transaction_master'[gl_category_1],",
    "            'transaction_master'[gl_category_2],",
    "            'transaction_master'[gl_category_3]",
    "        ),",
    "        'transaction_master'[gl_category_1] = \"SG&A\"",
    "    )",
    "VAR Actual_Other =",
    "    CALCULATE(",
    "        [Actual_rev],",
    "        REMOVEFILTERS(",
    "            'transaction_master'[gl_category_1],",
    "            'transaction_master'[gl_category_2],",
    "            'transaction_master'[gl_category_3]",
    "        ),",
    "        'transaction_master'[gl_category_1] = \"Other\"",
    "    )",
    "",
    "VAR Actual_ODE =",
    "    CALCULATE(",
    "        [Actual_rev],",
    "        REMOVEFILTERS(",
    "            'transaction_master'[gl_category_1],",
    "            'transaction_master'[gl_category_2],",
    "            'transaction_master'[gl_category_3]",
    "        ),",
    "        'transaction_master'[gl_category_1] = \"ODE\"",
    "    )",
    "",
    "VAR LY_Revenue =",
    "    CALCULATE(",
    "        [LY_rev],",
    "        REMOVEFILTERS(",
    "            'transaction_master'[gl_category_1],",
    "            'transaction_master'[gl_category_2],",
    "            'transaction_master'[gl_category_3]",
    "        ),",
    "        'transaction_master'[gl_category_1] = \"Revenue\"",
    "    )",
    "",
    "VAR LY_COGS =",
    "    CALCULATE(",
    "        [LY_rev],",
    "        REMOVEFILTERS(",
    "            'transaction_master'[gl_category_1],",
    "            'transaction_master'[gl_category_2],",
    "            'transaction_master'[gl_category_3]",
    "        ),",
    "        'transaction_master'[gl_category_1] = \"COGS\"",
    "    )",
    "VAR LY_SGA =",
    "    CALCULATE(",
    "        [LY_rev],",
    "        REMOVEFILTERS(",
    "            'transaction_master'[gl_category_1],",
    "            'transaction_master'[gl_category_2],",
    "            'transaction_master'[gl_category_3]",
    "        ),",
    "        'transaction_master'[gl_category_1] = \"SG&A\"",
    "    )",
    "VAR LY_Other =",
    "    CALCULATE(",
    "        [LY_rev],",
    "        REMOVEFILTERS(",
    "            'transaction_master'[gl_category_1],",
    "            'transaction_master'[gl_category_2],",
    "            'transaction_master'[gl_category_3]",
    "        ),",
    "        'transaction_master'[gl_category_1] = \"Other\"",
    "    )",
    "VAR LY_ODE =",
    "    CALCULATE(",
    "        [LY_rev],",
    "        REMOVEFILTERS(",
    "            'transaction_master'[gl_category_1],",
    "            'transaction_master'[gl_category_2],",
    "            'transaction_master'[gl_category_3]",
    "        ),",
    "        'transaction_master'[gl_category_1] = \"ODE\"",
    "    )",
    "",
    "VAR GP_Actual = Actual_Revenue - Actual_COGS",
    "VAR GP_LY = LY_Revenue - LY_COGS",
    "VAR GP_Delta = DIVIDE(GP_Actual - GP_LY, GP_LY)",
    "",
    "VAR EBITDA_Actual = Actual_Revenue - Actual_COGS - Actual_SGA",
    "VAR EBITDA_LY     = LY_Revenue - LY_COGS - LY_SGA",
    "VAR EBITDA_Delta  = DIVIDE(EBITDA_Actual - EBITDA_LY, EBITDA_LY)",
    "",
    "VAR NetIncome_Actual = Actual_Revenue - Actual_COGS - Actual_SGA - Actual_Other",
    "VAR NetIncome_LY     = LY_Revenue - LY_COGS - LY_SGA - LY_Other",
    "VAR NetIncome_Delta  = DIVIDE(NetIncome_Actual - NetIncome_LY, NetIncome_LY)",
    "",
    "VAR ODI_Actual = NetIncome_Actual + Actual_ODE",
    "VAR ODI_LY = NetIncome_LY + LY_ODE",
    "VAR ODI_Delta = DIVIDE(ODI_Actual - ODI_LY, ODI_LY)",
    "",
    "RETURN",
    "SWITCH(",
    "    TRUE(),",
    "",
    "    Item1 IN {\"Revenue\"}, Delta,",
    "",
    "    -- Flip sign for cost accounts",
    "    Item1 IN { \"COGS\", \"SG&A\", \"Other\" }, -Delta,",
    "",
    "    -- Apply GP-specific delta only for this calculation item",
    "    IsGrossProfitTotalRow, GP_Delta,",
    "    IsGrossProfitChildRow, Delta,",
    "",
    "    -- Apply EBIDTA-speciifc delta",
    "    IsEBITDATotalRow, EBITDA_Delta,",
    "    IsEBITDAChildRow, Delta,",
    "",
    "    -- Apply NetIncome-specific delta",
    "    IsNetIncomeTotalRow, NetIncome_Delta,",
    "    IsNetIncomeChildRow, Delta,",
    "",
    "    IsODITotalRow, ODI_Delta,",
    "    IsODIChildRow, Delta,",
    "",
    "    -- Default behavior",
    "    Delta",
    ")",
    ""
  ],
  "displayFolder": "_Measures_Active",
  "lineageTag": "57319168-db29-45fe-a29a-fec2405851fb",
  "formatStringDefinition": {
    "expression": [
      "\"#,##0%;(#,##0%);0%\"",
      ""
    ]
  },
  "changedProperties": [
    {
      "property": "DisplayFolder"
    },
    {
      "property": "FormatString"
    },
    {
      "property": "FormatStringDefinition"
    },
    {
      "property": "Name"
    }
  ]
}