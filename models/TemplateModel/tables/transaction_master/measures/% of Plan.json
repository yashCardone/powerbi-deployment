{
  "name": "% of Plan",
  "expression": [
    "",
    "VAR Item1 = SELECTEDVALUE( 'Financial Metrics'[Calculation group column] )",
    "",
    "// Detect total vs. child rows",
    "VAR IsGrossProfitTotalRow =",
    "    Item1 = \"Gross Profit\"",
    "    && NOT ISINSCOPE( transaction_master[gl_category_2] )",
    "    && NOT ISINSCOPE( transaction_master[gl_category_3] )",
    "",
    "VAR IsGrossProfitChildRow =",
    "    Item1 = \"Gross Profit\"",
    "    && SELECTEDVALUE( transaction_master[gl_category_1] ) IN { \"Revenue\", \"COGS\" }",
    "",
    "VAR IsEBITDATotalRow =",
    "    Item1 = \"EBITDA\"",
    "    && NOT ISINSCOPE( transaction_master[gl_category_2] )",
    "    && NOT ISINSCOPE( transaction_master[gl_category_3] )",
    "",
    "VAR IsEBITDAChildRow =",
    "    Item1 = \"EBITDA\"",
    "    && SELECTEDVALUE( transaction_master[gl_category_1] ) IN { \"Revenue\", \"COGS\", \"SG&A\" }",
    "",
    "VAR IsNetIncomeTotalRow =",
    "    Item1 = \"Net Income\"",
    "    && NOT ISINSCOPE( transaction_master[gl_category_2] )",
    "    && NOT ISINSCOPE( transaction_master[gl_category_3] )",
    "",
    "VAR IsNetIncomeChildRow =",
    "    Item1 = \"Net Income\"",
    "    && SELECTEDVALUE( transaction_master[gl_category_1] ) IN { \"Revenue\", \"COGS\", \"SG&A\", \"Other\" }",
    "",
    "VAR IsODITotalRow =",
    "    Item1 = \"Owners Discretionary Income\"",
    "    && NOT ISINSCOPE( transaction_master[gl_category_2] )",
    "    && NOT ISINSCOPE( transaction_master[gl_category_3] )",
    "",
    "VAR IsODIChildRow =",
    "    Item1 = \"Owners Discretionary Income\"",
    "    && SELECTEDVALUE( transaction_master[gl_category_1] ) IN { \"Revenue\", \"COGS\", \"SG&A\", \"Other\", \"ODE\" }",
    "",
    "// Base Plan for the current cell",
    "VAR PlanValue = [plan_rev]",
    "",
    "// Total Plan Revenue (for denominator)",
    "VAR TotalPlanRevenue =",
    "    CALCULATE(",
    "        [plan_rev],",
    "        REMOVEFILTERS(",
    "            transaction_master[gl_category_1],",
    "            transaction_master[gl_category_2],",
    "            transaction_master[gl_category_3]",
    "        ),",
    "        transaction_master[gl_category_1] = \"Revenue\"",
    "    )",
    "",
    "// Break out pieces for aggregates",
    "VAR Plan_Revenue = TotalPlanRevenue",
    "VAR Plan_COGS =",
    "    CALCULATE(",
    "        [plan_rev],",
    "        REMOVEFILTERS(",
    "            transaction_master[gl_category_1],",
    "            transaction_master[gl_category_2],",
    "            transaction_master[gl_category_3]",
    "        ),",
    "        transaction_master[gl_category_1] = \"COGS\"",
    "    )",
    "VAR Plan_SGA =",
    "    CALCULATE(",
    "        [plan_rev],",
    "        REMOVEFILTERS(",
    "            transaction_master[gl_category_1],",
    "            transaction_master[gl_category_2],",
    "            transaction_master[gl_category_3]",
    "        ),",
    "        transaction_master[gl_category_1] = \"SG&A\"",
    "    )",
    "VAR Plan_Other =",
    "    CALCULATE(",
    "        [plan_rev],",
    "        REMOVEFILTERS(",
    "            transaction_master[gl_category_1],",
    "            transaction_master[gl_category_2],",
    "            transaction_master[gl_category_3]",
    "        ),",
    "        transaction_master[gl_category_1] = \"Other\"",
    "    )",
    "VAR Plan_ODE =",
    "    CALCULATE(",
    "        [plan_rev],",
    "        REMOVEFILTERS(",
    "            transaction_master[gl_category_1],",
    "            transaction_master[gl_category_2],",
    "            transaction_master[gl_category_3]",
    "        ),",
    "        transaction_master[gl_category_1] = \"ODE\"",
    "    )",
    "",
    "// Compute each custom aggregate’s % of total Plan Revenue",
    "VAR GP_Percent =",
    "    DIVIDE( Plan_Revenue - Plan_COGS, TotalPlanRevenue, 0 )",
    "",
    "VAR EBITDA_Percent =",
    "    DIVIDE( Plan_Revenue - Plan_COGS - Plan_SGA, TotalPlanRevenue, 0 )",
    "",
    "VAR NetIncome_Percent =",
    "    DIVIDE(",
    "        Plan_Revenue",
    "        - Plan_COGS",
    "        - Plan_SGA",
    "        - Plan_Other,",
    "        TotalPlanRevenue,",
    "        0",
    "    )",
    "",
    "VAR ODI_Percent =",
    "    DIVIDE(",
    "        ( Plan_Revenue",
    "          - Plan_COGS",
    "          - Plan_SGA",
    "          - Plan_Other )",
    "        + Plan_ODE,",
    "        TotalPlanRevenue,",
    "        0",
    "    )",
    "",
    "// Standard % of total for detail rows",
    "VAR PP = DIVIDE( PlanValue, TotalPlanRevenue, 0 )",
    "",
    "// Return appropriate ratio per row",
    "RETURN",
    "SWITCH(",
    "    TRUE(),",
    "      // pure % of plan‐revenue for line‐items",
    "    Item1 = \"Revenue\",                PP,",
    "    Item1 IN { \"COGS\",\"SG&A\",\"Other\",\"ODE\" }, PP,",
    "",
    "      // Gross Profit",
    "    IsGrossProfitTotalRow,            GP_Percent,",
    "    IsGrossProfitChildRow,            PP,",
    "",
    "      // EBITDA",
    "    IsEBITDATotalRow,                 EBITDA_Percent,",
    "    IsEBITDAChildRow,                 PP,",
    "",
    "      // Net Income",
    "    IsNetIncomeTotalRow,              NetIncome_Percent,",
    "    IsNetIncomeChildRow,              PP,",
    "",
    "      // Owners Discretionary Income",
    "    IsODITotalRow,                    ODI_Percent,",
    "    IsODIChildRow,                    PP,",
    "",
    "    BLANK()",
    ")",
    ""
  ],
  "formatString": "0%;-0%;0%",
  "displayFolder": "_Measures_Active",
  "lineageTag": "f4932825-9200-4a30-a732-8a1ab42e07a7",
  "changedProperties": [
    {
      "property": "DisplayFolder"
    },
    {
      "property": "Name"
    },
    {
      "property": "FormatString"
    }
  ]
}