{
  "name": "Var_to_LY",
  "expression": [
    "",
    "VAR Actual = [Actual_rev]",
    "VAR LY     = [LY_rev]",
    "",
    "VAR Item1   = SELECTEDVALUE('Financial Metrics'[Calculation group column])",
    "",
    "VAR Delta  =  Actual - LY",
    "",
    "-- Detect if we're on the \"Gross Profit\", \"EBITDA\", \"Net Income\" row",
    "VAR IsGrossProfitTotalRow =",
    "    Item1 = \"Gross Profit\" &&",
    "    NOT ISINSCOPE('transaction_master'[gl_category_2]) &&",
    "    NOT ISINSCOPE('transaction_master'[gl_category_3])",
    "VAR IsEBITDATotalRow =",
    "    Item1 = \"EBITDA\" &&",
    "    NOT ISINSCOPE('transaction_master'[gl_category_2]) &&",
    "    NOT ISINSCOPE('transaction_master'[gl_category_3])",
    "VAR IsNetIncomeTotalRow =",
    "    Item1 = \"Net Income\" &&",
    "    NOT ISINSCOPE('transaction_master'[gl_category_2]) &&",
    "    NOT ISINSCOPE('transaction_master'[gl_category_3])",
    "VAR IsODITotalRow =",
    "    Item1 = \"Owners Discretionary Income\" &&",
    "    NOT ISINSCOPE('transaction_master'[gl_category_2]) &&",
    "    NOT ISINSCOPE('transaction_master'[gl_category_3])",
    "",
    "-- Custom GP/Ebitda/NetIncome logic",
    "VAR Actual_Revenue = CALCULATE(",
    "    [Actual_rev],",
    "    REMOVEFILTERS('transaction_master'[gl_category_1], 'transaction_master'[gl_category_2], 'transaction_master'[gl_category_3]),",
    "    'transaction_master'[gl_category_1] = \"Revenue\"",
    ")",
    "",
    "VAR Actual_COGS = CALCULATE(",
    "    [Actual_rev],",
    "    REMOVEFILTERS('transaction_master'[gl_category_1], 'transaction_master'[gl_category_2], 'transaction_master'[gl_category_3]),",
    "    'transaction_master'[gl_category_1] = \"COGS\"",
    ")",
    "",
    "VAR Actual_SGA = CALCULATE(",
    "    [Actual_rev],",
    "    REMOVEFILTERS('transaction_master'[gl_category_1], 'transaction_master'[gl_category_2], 'transaction_master'[gl_category_3]),",
    "    'transaction_master'[gl_category_1] = \"SG&A\"",
    ")",
    "",
    "VAR Actual_Other = CALCULATE(",
    "    [Actual_rev],",
    "    REMOVEFILTERS('transaction_master'[gl_category_1], 'transaction_master'[gl_category_2], 'transaction_master'[gl_category_3]),",
    "    'transaction_master'[gl_category_1] = \"Other\"",
    ")",
    "",
    "VAR Actual_ODE = CALCULATE(",
    "    [Actual_rev],",
    "    REMOVEFILTERS('transaction_master'[gl_category_1], 'transaction_master'[gl_category_2], 'transaction_master'[gl_category_3]),",
    "    'transaction_master'[gl_category_1] = \"ODE\"",
    ")",
    "",
    "VAR LY_Revenue = CALCULATE(",
    "    [LY_rev],",
    "    REMOVEFILTERS('transaction_master'[gl_category_1], 'transaction_master'[gl_category_2], 'transaction_master'[gl_category_3]),",
    "    'transaction_master'[gl_category_1] = \"Revenue\"",
    ")",
    "",
    "VAR LY_COGS = CALCULATE(",
    "    [LY_rev],",
    "    REMOVEFILTERS('transaction_master'[gl_category_1], 'transaction_master'[gl_category_2], 'transaction_master'[gl_category_3]),",
    "    'transaction_master'[gl_category_1] = \"COGS\"",
    ")",
    "",
    "VAR LY_SGA = CALCULATE(",
    "    [LY_rev],",
    "    REMOVEFILTERS('transaction_master'[gl_category_1], 'transaction_master'[gl_category_2], 'transaction_master'[gl_category_3]),",
    "    'transaction_master'[gl_category_1] = \"SG&A\"",
    ")",
    "",
    "VAR LY_Other = CALCULATE(",
    "    [LY_rev],",
    "    REMOVEFILTERS('transaction_master'[gl_category_1], 'transaction_master'[gl_category_2], 'transaction_master'[gl_category_3]),",
    "    'transaction_master'[gl_category_1] = \"Other\"",
    ")",
    "",
    "VAR LY_ODE = CALCULATE(",
    "    [LY_rev],",
    "    REMOVEFILTERS('transaction_master'[gl_category_1], 'transaction_master'[gl_category_2], 'transaction_master'[gl_category_3]),",
    "    'transaction_master'[gl_category_1] = \"ODE\"",
    ")",
    "",
    "VAR GP_Actual = Actual_Revenue - Actual_COGS",
    "VAR GP_LY     = LY_Revenue - LY_COGS",
    "VAR GP_Delta  = GP_Actual - GP_LY",
    "",
    "VAR Ebitda_Actual = Actual_Revenue - Actual_COGS - Actual_SGA",
    "VAR Ebitda_LY = LY_Revenue - LY_COGS - LY_SGA",
    "VAR Ebitda_Delta = Ebitda_Actual - Ebitda_LY",
    "",
    "VAR NetIncome_Actual = Actual_Revenue - Actual_COGS - Actual_SGA - Actual_Other",
    "VAR NetIncome_LY = LY_Revenue - LY_COGS - LY_SGA - LY_Other",
    "VAR NetIncome_Delta = NetIncome_Actual - NetIncome_LY",
    "",
    "VAR ODI_Actual = NetIncome_Actual + Actual_ODE",
    "VAR ODI_LY = NetIncome_LY + LY_ODE",
    "VAR ODI_Delta = ODI_Actual - ODI_LY",
    "",
    "RETURN",
    "    SWITCH(",
    "        TRUE(),",
    "        Item1 IN { \"COGS\", \"SG&A\", \"Other\" }, -1 * Delta,",
    "        IsGrossProfitTotalRow, GP_Delta,",
    "        IsEBITDATotalRow, Ebitda_Delta,",
    "        IsNetIncomeTotalRow, NetIncome_Delta,",
    "        IsODITotalRow, ODI_Delta,",
    "",
    "        Delta",
    "    )"
  ],
  "displayFolder": "_Measures_Active",
  "lineageTag": "73ef2ca5-51f0-4a95-8490-953dca1da0ab",
  "formatStringDefinition": {
    "expression": "\"#,##0;(#,##0);0\""
  },
  "changedProperties": [
    {
      "property": "DisplayFolder"
    },
    {
      "property": "FormatString"
    },
    {
      "property": "FormatStringDefinition"
    }
  ]
}